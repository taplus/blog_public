[{"content":"","date":"2024-7-23","externalUrl":null,"permalink":"/blog/","section":"Blogs","summary":"","title":"Blogs","type":"blog"},{"content":"这是一份做了五个月的作业，花费了不少时间、精力、金钱，写在这里做个记录。\n硬件选型 # 我日常使用的设备是一台 16G + 256G 的 M2 Mac Mini，托「库存克星」的福，日常使用的槽点就是逼仄的存储空间和羸弱的游戏性能。我拒绝继续向果子充钱，因此组台能填补这两块短板的 AIO 就提上了日程，由于空间限制和噪音敏感，我一开始的选型就瞄准在了小体积、全闪存和能塞得下一张显卡的小主机上。\n经过一段时间的寻找，已经停产了的 NUC 9 幽灵峡谷成了唯一候选。5L 的小体积塞的下 20cm 长的双槽显卡，配备了3 块 m2 硬盘位，外加 1 个 sata 共计 4 块硬盘，背部配了两个雷电 3 接口，还有白金的 500W Flex 电源，简直就是量身定制。更重要的是截至 2024 年年中，在第三方平台上 i7 版本仅需 1500 就能到手，因此果断下单。然而由于一些原因，我最终换成了 NUC 11。相较 NUC 9，NUC11 Extreme 猛兽峡谷体积大了两圈来到了 8.4 L， CPU 从 9 代笔记本标压 U 升级为 10nm 制程的 i7-11700B，相应的 PCIE 3 升级到了 PCIE 4，雷电 3 升级到雷电 4 。但精巧的 Flex 白金电源降级为 SFX 金牌电源，整体精致感也少了很多，换来的是更强的性能，只能说有失有得吧。\n机子只是台准系统，我加装了 64GB DDR4 3200内存，配了一张华硕 4060 Dual 显卡用来直通给 Win10 虚拟机。存储方面是氪金大头，作为一台全闪 AIO，用满了 NUC 11 的4块 m2 存储位：3块 4T 联芸 MAP1602 + 长江存储 232 层 TLC 组建 raidz1 阵列，实现全闪、全万兆的性能。 外加 1 块 1T 的 SN580 直通给 Windows。\n软件方案 # 宿主机系统：用 Windows + hyperV 很方便，但 Win 下的 hyperV 不支持硬件直通，转而选择了比较熟悉的 PVE作为宿主机系统。 PVE 安装在 U 盘里，可以省下一个硬盘位。考虑到 U 盘读写性能，PVE配置无SWAP，local 仅存放 truenas 引导，Windows 单独直通一块 SSD 使用，其他虚拟机采用 NFS 存储。\n虚拟机 truenas ：raidz1 阵列可用容量 8T，分配了 16G 的内存。\n虚拟机 Windows ：使用 sunshine + moonlight 远程串流，不玩 FPS，延迟近乎无感。参照这篇文章做了 anti-cheat 配置，同时开启了 Hyper-V 使用 WSL。（所以我的 Windows VM 是跑在第三层嵌套虚拟化上的？）\nUPS 配置：都用 AIO 了，UPS 不能省。虽然这样一来，整套设备又离小体积更远了。参照 chiphell 的这篇文章配置了断电 60s 自动关闭所有虚拟机，180s 关闭宿主机。\n性能测试 # 存储性能 fio 写性能 3.5 GB/s，读性能 4 GB/s 。 dd 写性能 10.4 GB/s，读性能 16.3 GB/s。 virtio 跑满 20 Gb/s，SMB 3 网络硬盘速度读写大概 3 GB/s。\n雷电网桥性能 truenas 和 Mac Mini 开启 9000 MTU，iperf 3 测试速度 9.29 Gb/s。\nWindows 虚拟机性能 由于 WSL 需求，开启了 Hyper-V 。在性能方面有一些损失，跑了 GeekBench，单核 2000，多核 9000，相较裸机直装损失在10% 左右。\n踩坑 # 已解决 # NUC 11 接 UPS 后执行关机命令后自动重启。 这是由于 BIOS 中配置了USB 自动唤醒，Intel 官方解决方案。 未解决 # raidz1 阵列速度问题：fio 本地测试阵列速度，写速度 3.5 GB/s，读速度 4 GB/s，基本只有单盘 PCIE 3 nvme 的速度，远不及 PCIE 4 nvme 速度。目前猜测瓶颈在 CPU 做 raidz1 奇偶校验速度，或者是其中一块 nvme 连在总线的 PCIE 3 通道而非和另外两块一样直连 CPU 的 PCIE 4通道。所以 raidz1 的阵列理论速度到底怎么算？\n雷电传输速度问题：直通给 truenas 的雷电 4 连接 Mac Mini 跑硬盘测试，速度甚至到不了万兆，猜测是雷电网桥的瓶颈，可能是线材的问题或是系统兼容问题。\nNUC 11 计算板有一个 Type-e 接口，买了一个 Type-e 转 USB 的转接器，U 盘用转接器插在这个接口上，结果 BIOS 启动项里根本找不到这个 U 盘。\nF\u0026amp;Q # 为什么从 NUC 9 换成 NUC 11 ？ truenas直通 3 块 4T nvme。不知道是硬件问题还是 BIOS 问题，NUC 9 其中一个硬盘位就是没办法直通给虚拟机，在 chiphell 发帖问了下，也没解决方案。另外机器到手后发现，NUC 9 计算板上的两条 m2 ，雷电 3 共享 PCIE 3 x4 的 DMI 总线。最后联系了华硕售后（Intel Nuc 业务已经整体卖给了华硕），客服回电告知没有备件，换了 NUC 11 良品，来回免运费。\n为什么不做存算分离？ 空间限制。而且我玩游戏不多，单独配一台游戏PC没有必要，但不能没有。因此把 4060 放在 AIO 里，4060 待机功耗也不高，后面还可以玩一玩本地 LLM 和 blender 渲染。\n为什么选择 raidz1 ？ mirror 太浪费，raid0 属实亡命之徒，而且我还有一台装了 2T sata 的 J4125小主机，用 Free File Sync 监控 truenas 重要数据文件夹作为备份，兼顾了空间和数据安全。\n功耗如何？ 没有测量过。但 510W 的 UPS 在 AIO 待机状态下显示负载为 10%。游戏满载时负载 35%，NUC 11的 CPU TDP 满载 65W，4060 满载 115W，因此估算待机功耗应该在 60W 左右。\n最后 # 起步小白，折腾五个月，还有这样那样的小问题，但总算是能用了，其他的后续慢慢学习优化吧。折腾的时候是真痛苦，折腾完了又感觉索然无味。这台机子还有很大的改进空间，后续也可以加装 40G 网卡真正发挥全闪 nas 的实力。但就目前而言，这台机子最大的缺点在于每次看到它，就让我怀念起那台漂亮的、精致小巧的，但被华硕「友好」回收了的幽灵峡谷。看着越来越大的「NUC」，幽灵峡谷真成绝版了，Sad～～～\n","date":"2024-7-23","externalUrl":null,"permalink":"/blog/nuc11-aio-tinkering/","section":"Blogs","summary":"这是一份做了五个月的作业，花费了不少时间、精力、金钱，写在这里做个记录。","title":"NUC11 AIO 折腾小记","type":"blog"},{"content":"","date":"2024-7-23","externalUrl":null,"permalink":"/","section":"TAPLUS","summary":"","title":"TAPLUS","type":"page"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"},{"content":"","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"}]